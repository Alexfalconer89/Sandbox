{"job":{"components":{"196944":{"id":196944,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[196995],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196949":{"id":196949,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":144,"y":0,"width":32,"height":32,"inputConnectorIDs":[196995],"outputSuccessConnectorIDs":[196948],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Completed At","mapTo":"Error_CompletedAt"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"Error_Component"},"3":{"slot":3,"fromId":null,"fromName":"Duration","mapTo":"Error_Duration"},"4":{"slot":4,"fromId":null,"fromName":"Message","mapTo":"Error_Message"},"5":{"slot":5,"fromId":null,"fromName":"Row Count","mapTo":"Error_RowCount"},"6":{"slot":6,"fromId":null,"fromName":"Started At","mapTo":"Error_StartedAt"},"7":{"slot":7,"fromId":null,"fromName":"Status","mapTo":"Error_Status"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Connected Packaging signups Table Creation"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nProgram           : Daily Connected Packaging Creation > Table Outputs\nAuthor            : Chris B\nClient Name       : Nestle\nJob Number        :\nStandard Machine  : Snowflake\nAmendment History : v01 \n******************************************************************************************/\n\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'Connected Packaging Table Creation',\n    'SCRIPT',\n    'STARTED';\n\n\n--alter warehouse set warehouse_size = 'Large';\n\n--=================================\n--        MAIN CP TABLES\n--=================================\n\n/*\n•\tURN – Unique at CID level. \n•\tDate of sign up\n•\tTime of sign up\n•\tForm name (Purina Website or HHGi webform) \n•\tBrand name (GP or KC)\n•\tUpdated pet’s birthday in welcome email (Y/N/ Not applicable) \n*/\n\n\ncreate or replace table ${Database}.temp.GP_KC_connected_packaging\nas\nselect \n    name_urn, \n    signup_date,\n    signup_time,\n    form_name,\n    brand_name,\n    updated_bday \nfrom (\n        select \n            --a.cid,\n            name_urn, \n            signup_date,\n            signup_time,\n            form_name,\n            brand_name,\n            case when p.cid is not null then 1 else 0 end as updated_bday,  \n            row_number() over(partition by a.cid, brand_name order by signup_time asc nulls last) as rn\n        from (\n                select \n                    distinct\n                        cid,\n                        su.name_urn, \n                        cast(TIMESTAMP as date) as signup_date,\n                        cast(TIMESTAMP as time) as signup_time,\n                        SOURCE_CAMPAIGN||' Form' as form_name,\n                        SOURCE_CAMPAIGN as brand_name\n                from ${Database}.DB.NPP_GP_KC_connected_packaging_adestra_responses su\n                join ${Database}.live.xref_name_urn x on x.name_urn = su.name_urn\n                where lower(SOURCE_CAMPAIGN) = 'growing pup' \n            UNION ALL\n                select \n                    distinct\n                        cid,\n                        su.name_urn, \n                        cast(TIMESTAMP as date) as signup_date,\n                        cast(TIMESTAMP as time) as signup_time,\n                        SOURCE_CAMPAIGN||' Form' as form_name,\n                        SOURCE_CAMPAIGN as brand_name\n                from ${Database}.DB.NPP_GP_KC_connected_packaging_adestra_responses su\n                join ${Database}.live.xref_name_urn x on x.name_urn = su.name_urn\n                where lower(SOURCE_CAMPAIGN) = 'kitten code' \n            UNION ALL\t\t\t\t\t\t\t \n                select \n                    distinct\n                        cid,\n                        na.name_urn, \n                        cast(ACCOUNT_CREATED as date) as signup_date,\n                        ACCOUNT_CREATED as signup_time,\n                        'Purina Registration' as form_name,\n                        'Growing Pup' as brand_name\n                from ${Database}.DB.names_attributes na\n                join ${Database}.live.xref_name_urn x on x.name_urn = na.name_urn\n                join ${Database}.db.names n on n.name_urn = na.name_urn\n                where n.source_brand_id = (select brand_id from ${Database}.live.ref_brand where lower(brand) = 'growing pup')\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \n                and lower(na.REGISTRATION_CAMPAIGN) in ('connected packaging') \n                and na.source = 'REG_WUN'\n            UNION ALL\t\t\t\t\t\t\t \n                select \n                    distinct\n                        cid,\n                        na.name_urn, \n                        cast(ACCOUNT_CREATED as date) as signup_date,\n                        ACCOUNT_CREATED as signup_time,\n                        'Purina Registration' as form_name,\n                        'Kitten Code' as brand_name\n                from ${Database}.DB.names_attributes na\n                join ${Database}.live.xref_name_urn x on x.name_urn = na.name_urn\n                join ${Database}.db.names n on n.name_urn = na.name_urn\n                where n.source_brand_id = (select brand_id from ${Database}.live.ref_brand where lower(brand) = 'kitten code')\n                and lower(na.REGISTRATION_CAMPAIGN) in ('connected packaging') \n                and na.source = 'REG_WUN'\t\t\t\t\n            ) a  \n            LEFT JOIN (select distinct cid \n                       from ${Database}.db.pet p\n                       join ${Database}.live.xref_name_urn x on x.name_urn = p.name_urn\n                       where (p.pet_age_months is not null or p.pet_age_years is not null or pet_age_weeks is not null or pet_birth_month is not null)\n                       and p.source = 'GrowingPup_PDC'\n                       ) p on p.cid = a.cid\n        )b  \n        where rn = 1\n        and signup_date > '2022-05-20'\n;\n\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'Connected Packaging Table Creation',\n    'SCRIPT',\n    'FINISHED';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196950":{"id":196950,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":304,"y":0,"width":32,"height":32,"inputConnectorIDs":[196948],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Completed At","mapTo":"Error_CompletedAt"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"Error_Component"},"3":{"slot":3,"fromId":null,"fromName":"Duration","mapTo":"Error_Duration"},"4":{"slot":4,"fromId":null,"fromName":"Message","mapTo":"Error_Message"},"5":{"slot":5,"fromId":null,"fromName":"Row Count","mapTo":"Error_RowCount"},"6":{"slot":6,"fromId":null,"fromName":"Started At","mapTo":"Error_StartedAt"},"7":{"slot":7,"fromId":null,"fromName":"Status","mapTo":"Error_Status"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Connected Packaging report File Output"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'Connected Packaging File Outputs',\n    'SCRIPT',\n    'STARTED';\n\n\n--=================================\n--        MAIN PDC OUTPUTS\n--=================================\n\ncopy into 's3://bbw-staging-nestle/data_out/Connected_packaging_report/GP_KC_connected_packaging_report.csv'\nfrom ${Database}.temp.GP_KC_connected_packaging\nstorage_integration = nestle_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:MM:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\n\n\n--alter warehouse set warehouse_size = 'Xsmall';\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'Connected packaging report File Output',\n    'SCRIPT',\n    'FINISHED';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"196948":{"id":196948,"sourceID":196949,"targetID":196950}},"failureConnectors":{},"unconditionalConnectors":{"196995":{"id":196995,"sourceID":196944,"targetID":196949}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"Daily Connected Packaging report Output","description":"","type":"ORCHESTRATION","tag":"c4961a1e-2509-43f2-b14b-22fa2d622c64"}}