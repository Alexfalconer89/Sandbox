{"job":{"components":{"196981":{"id":196981,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":304,"y":0,"width":32,"height":32,"inputConnectorIDs":[196980],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Completed At","mapTo":"Error_CompletedAt"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"Error_Component"},"3":{"slot":3,"fromId":null,"fromName":"Duration","mapTo":"Error_Duration"},"4":{"slot":4,"fromId":null,"fromName":"Message","mapTo":"Error_Message"},"5":{"slot":5,"fromId":null,"fromName":"Row Count","mapTo":"Error_RowCount"},"6":{"slot":6,"fromId":null,"fromName":"Started At","mapTo":"Error_StartedAt"},"7":{"slot":7,"fromId":null,"fromName":"Status","mapTo":"Error_Status"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PDC File Outputs"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'PDC File Outputs',\n    'SCRIPT',\n    'STARTED';\n\n\n--=================================\n--        MAIN PDC OUTPUTS\n--=================================\n\ncopy into 's3://${Bucket}/data_out/PDC_Population/ACTIVE_BBWURNS.csv'\nfrom ${Database}.jobs.pdc_active_urns\nstorage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\ncopy into 's3://${Bucket}/data_out/PDC_Population/DATA.csv'\nfrom ${Database}.jobs.pdc_population\nstorage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\ncopy into 's3://${Bucket}/data_out/PDC_Population/DATA_EXTRA.csv'\nfrom ${Database}.jobs.pdc_population_detail\nstorage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\n--=================================\n--     YOUR PURINA PDC OUTPUTS\n--=================================\n\ncopy into 's3://${Bucket}/data_out/PDC_Population/ACTIVE_YP_BBWURNS.csv'\nfrom ${Database}.jobs.yp_pdc_active_urns\nstorage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\ncopy into 's3://${Bucket}/data_out/PDC_Population/YP_USER_DATA.csv'\nfrom ${Database}.jobs.yp_pdc_population_userdetail\nstorage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\ncopy into 's3://${Bucket}/data_out/PDC_Population/YP_PET_DATA.csv'\nfrom ${Database}.jobs.yp_pdc_population_petdetail\nstorage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n    EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = FALSE\nMAX_FILE_SIZE=5368709120;\n\n\n--alter warehouse set warehouse_size = 'Xsmall';\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'PDC File Outputs',\n    'SCRIPT',\n    'FINISHED';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196982":{"id":196982,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":144,"y":0,"width":32,"height":32,"inputConnectorIDs":[196987],"outputSuccessConnectorIDs":[196980],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Completed At","mapTo":"Error_CompletedAt"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"Error_Component"},"3":{"slot":3,"fromId":null,"fromName":"Duration","mapTo":"Error_Duration"},"4":{"slot":4,"fromId":null,"fromName":"Message","mapTo":"Error_Message"},"5":{"slot":5,"fromId":null,"fromName":"Row Count","mapTo":"Error_RowCount"},"6":{"slot":6,"fromId":null,"fromName":"Started At","mapTo":"Error_StartedAt"},"7":{"slot":7,"fromId":null,"fromName":"Status","mapTo":"Error_Status"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PDC Table Creations"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nProgram           : Daily PDC Creation > Table Outputs\nAuthor            : ?\nClient Name       : Nestle\nJob Number        :\nStandard Machine  : Snowflake\nAmendment History : v01 \n                    v02 - NPP08485 PDC PupAge addition\n                    v03 - NPP08750 PDC Optimisation: PupAge>GPKCAge rename; AvatarId addition\n\t\t\t\t\tv04 - SM 20220913 - NPP10442 Purina GUID Updates - changing hashed bbw_urn to guid to be consistent with pet avatar\n******************************************************************************************/\n\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'PDC Table Creation',\n    'SCRIPT',\n    'STARTED';\n\n\n--alter warehouse set warehouse_size = 'Large';\n\n--=================================\n--        MAIN PDC TABLES\n--=================================\n\ncreate or replace table ${Database}.jobs.pdc_active_urns\nas\nselect\n    ('E543438A-77B8-14E6-8396-'||replace(to_char(bbw_urn,'XXXXXXXXXXXX'),' ','0') ) as bbw_urn_sha256\nfrom ${Database}.live.cid;\n\n\ncreate or replace table ${Database}.jobs.pdc_population\nas\nselect\n    p.pet_id as id,\n    case\n        when p.pet_dob is null then ''\n        else to_char(p.pet_dob,'Mon')\n    end as birthmonth,\n    floor((current_date - p.pet_dob)/365) as pet_age,\n    coalesce(p.pet_name,'') as petname,\n    coalesce(p.pet_type,'') as pettype,\n    ('E543438A-77B8-14E6-8396-'||replace(to_char(bbw_urn,'XXXXXXXXXXXX'),' ','0') ) as uniqueid,\n    p.pet_data_date,\n    trim(case\n             when p.pet_name > '' and p.pet_type in ('Cat','Dog') and floor((current_date - p.pet_dob)/365) >= 0 and p.pet_dob >= add_months(current_date,-12)-10 then 'GrowingPup|BTGPKC|BTWelcome|BetterTogether'\n             when p.pet_name > '' and p.pet_type > '' then 'BTGPKC|BTWelcome|BetterTogether'\n             else ''\n         end) as campaigns,\n    current_timestamp as refresh_date,\n    case \n        when floor((current_date - p.pet_dob)/365) >= 0 and p.pet_dob >= add_months(current_date,-12)-10 and p.pet_type in ('Dog','Cat') --Puppy/Kitten less than 1 years and 10 days of age\n        then case \n                when current_date - p.pet_dob < ( 9 * 7) then  '8 weeks'\n                when current_date - p.pet_dob < (10 * 7) then  '9 weeks'\n                when current_date - p.pet_dob < (11 * 7) then '10 weeks'\n                when current_date - p.pet_dob < (12 * 7) then '11 weeks'\n                when current_date - p.pet_dob < (13 * 7) then '12 weeks'\n                when current_date - p.pet_dob < (14 * 7) then '13 weeks'\n                when current_date - p.pet_dob < (15 * 7) then '14 weeks'\n                when current_date - p.pet_dob < (16 * 7) then '15 weeks'\n                when current_date - p.pet_dob < (17 * 7) then '16 weeks'\n                when p.pet_dob >= add_months(current_date, -6) then  '5 months'\n                when p.pet_dob >= add_months(current_date, -7) then  '6 months'\n                when p.pet_dob >= add_months(current_date, -8) then  '7 months'\n                when p.pet_dob >= add_months(current_date, -9) then  '8 months'\n                when p.pet_dob >= add_months(current_date,-10) then  '9 months'\n                when p.pet_dob >= add_months(current_date,-11) then '10 months'\n                when p.pet_dob >= add_months(current_date,-12) then '11 months'\n                when p.pet_dob >= add_months(current_date,-12)-10 and p.pet_dob < add_months(current_date,-12) then '1 year'\n                else ''\n             end\n        else ''\n     end as gpkcage,\n    p.avatarid as avatarid\nfrom ${Database}.live.cid c\njoin ${Database}.live.cid_pet p on p.cid = c.cid\n;\n\n\ncreate or replace table ${Database}.jobs.pdc_population_detail\nas\nselect distinct\n    a.id,\n    a.cathabitid,\n    coalesce(catbreedid,dogbreedid) as petbreedid,\n    coalesce(catcolourid,dogcolourid) as petcolourid,\n    a.id as petdetailid,\n    a.petgenderid\nfrom (\n         select\n             p.pet_id as id,\n             coalesce(hab.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'CAT_HABIT' and ordernum = 0)) as cathabitid,\n             case when pet_type = 'Cat' then coalesce(cbr.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'CAT_BREED' and ordernum = 0)) end as catbreedid,\n             case when pet_type = 'Dog' then coalesce(dbr.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'DOG_BREED' and ordernum = 0)) end as dogbreedid,\n             case when pet_type = 'Cat' then coalesce(ccol.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'CAT_COLOUR' and ordernum = 0)) end as catcolourid,\n             case when pet_type = 'Dog' then coalesce(dcol.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'DOG_COLOUR' and ordernum = 0)) end as dogcolourid,\n             coalesce(gen.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'GENDER' and ordernum = 0)) as petgenderid\n         from ${Database}.jobs.pdc_population pp\n         join ${Database}.live.cid_pet p on pp.id = p.pet_id\n         left join ${Database}.db.ref_npp_pdc_ids hab on hab.description = decode(p.pet_indoor_outdoor,'I','Indoors','O','Outdoors','Not Set')\n                                                and lower(p.pet_type) rlike '.*cat.*'\n                                                and hab.category = 'CAT_HABIT'\n         left join ${Database}.db.ref_npp_pdc_ids cbr on lower(cbr.description) = lower(p.pet_breed)\n                                                and lower(p.pet_type) rlike '.*cat.*'\n                                                and cbr.category = 'CAT_BREED'\n         left join ${Database}.db.ref_npp_pdc_ids dbr on lower(dbr.description) = lower(p.pet_breed)\n                                                and lower(p.pet_type) rlike '.*dog.*'\n                                                and dbr.category = 'DOG_BREED'\n         left join ${Database}.db.ref_npp_pdc_ids ccol on lower(ccol.code) = lower(p.pet_colour)\n                                                 and lower(p.pet_type) rlike '.*cat.*.*'\n                                                 and ccol.category = 'CAT_COLOUR'\n         left join ${Database}.db.ref_npp_pdc_ids dcol on lower(dcol.code) = lower(p.pet_colour)\n                                                 and lower(p.pet_type) rlike '.*dog.*'\n                                                 and dcol.category = 'DOG_COLOUR'\n         left join ${Database}.db.ref_npp_pdc_ids gen on gen.description = decode(lower(left(p.pet_gender,1)),'m','Male','f','Female','Unspecified')\n                                                and gen.category = 'GENDER'\n     ) a;\n\n\n--=================================\n--      YOUR PURINA PDC TABLES\n--=================================\n\ncreate or replace table ${Database}.jobs.yp_pdc_active_urns\nas\nselect\n    bbw_urn,\n    ('E543438A-77B8-14E6-8396-'||replace(to_char(bbw_urn,'XXXXXXXXXXXX'),' ','0') ) as bbw_urn_sha256\nfrom ${Database}.live.cid;\n\n\ncreate or replace table ${Database}.jobs.yp_pdc_population_userdetail\nas\nselect \n    '42E37071-00F283-53BA-'||replace(to_char(bbw_urn,'XXXXXXXXXXXX'),' ','0') as id,\n    forename as firstname,\n    'NPP07398_Your_Purina_'||to_char(current_date,'YYYYMMDD') as campaignname,\n    0 as completed,\n    uniqueid as uniqueid,\n    cast('' as varchar(255)) as campaigns,\n    current_timestamp as refresh_date\nfrom ${Database}.temp.NPP07398_tr_your_purina_1;\n\n\ncreate or replace table ${Database}.jobs.yp_pdc_population_petdetail\nas\nselect distinct\n    a.id,\n    a.birthmonth,\n    a.cathabitid,\n    a.petage,\n    coalesce(catbreedid,dogbreedid) as petbreedid,\n    coalesce(catcolourid,dogcolourid) as petcolourid,\n    a.petgenderid,\n    a.petname,\n    a.pettype,\n    a.userdetailid\nfrom (\n         select\n             p.pet_id as id,\n             case\n                 when p.pet_dob is null then ''\n                 else to_char(p.pet_dob,'Mon')\n             end as birthmonth,\n             coalesce(hab.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'CAT_HABIT' and ordernum = 0)) as cathabitid,\n             case\n                 when (current_date - p.pet_dob)/365 < 0 then '-1'\n                 when (current_date - p.pet_dob)/365 is null then '-1'\n                 else floor((current_date - p.pet_dob)/365)\n             end as petage,\n             case when pet_type = 'Cat' then coalesce(cbr.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'CAT_BREED' and ordernum = 0)) end as catbreedid,\n             case when pet_type = 'Dog' then coalesce(dbr.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'DOG_BREED' and ordernum = 0)) end as dogbreedid,\n             case when pet_type = 'Cat' then coalesce(ccol.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'CAT_COLOUR' and ordernum = 0)) end as dogcolourid,\n             case when pet_type = 'Dog' then coalesce(dcol.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'DOG_COLOUR' and ordernum = 0)) end as catcolourid,\n             coalesce(gen.id,(select id from ${Database}.db.ref_npp_pdc_ids where category = 'GENDER' and ordernum = 0)) as petgenderid,\n             initcap(p.pet_type) as pettype,\n             p.pet_name as petname,\n             u.id as userdetailid\n \t     from ${Database}.jobs.yp_pdc_population_userdetail u\n\t     join ${Database}.live.xref_name_urn xr on ('E543438A-77B8-14E6-8396-'||replace(to_char(bbw_urn,'XXXXXXXXXXXX'),' ','0') ) = u.uniqueid\n \t     join ${Database}.live.cid_pet p on p.cid = xr.cid\n         left join ${Database}.db.ref_npp_pdc_ids hab on hab.description = decode(p.pet_indoor_outdoor, 'I','Indoors','O','Outdoors','Not Set')\n                                                and lower(p.pet_type) rlike '.*cat.*'\n                                                and hab.category = 'CAT_HABIT'\n         left join ${Database}.db.ref_npp_pdc_ids cbr on lower(cbr.description) = lower(p.pet_breed)\n                                                and lower(p.pet_type) rlike '.*cat.*'\n                                                and cbr.category = 'CAT_BREED'\n         left join ${Database}.db.ref_npp_pdc_ids dbr on lower(dbr.description) = lower(p.pet_breed)\n                                                and lower(p.pet_type) rlike '.*dog.*'\n                                                and dbr.category = 'DOG_BREED'\n         left join ${Database}.db.ref_npp_pdc_ids ccol on lower(ccol.code) = lower(p.pet_colour)\n                                                 and lower(p.pet_type) rlike '.*cat.*'\n                                                 and ccol.category = 'CAT_COLOUR'\n         left join ${Database}.db.ref_npp_pdc_ids dcol on lower(dcol.code) = lower(p.pet_colour)\n                                                 and lower(p.pet_type) rlike '.*dog.*'\n                                                 and dcol.category = 'DOG_COLOUR'\n         left join ${Database}.db.ref_npp_pdc_ids gen on gen.description = decode(lower(left(p.pet_gender,1)),'m','Male','f','Female','Unspecified')\n                                                and gen.category = 'GENDER'\n     ) a;\n\n\nmerge into ${Database}.jobs.yp_pdc_population_userdetail pp\nusing (\n          select distinct\n              userdetailid\n          from ${Database}.jobs.yp_pdc_population_petdetail\n          where petname > ''\n              and pettype > ''\n      ) as pd   on pp.Id = pd.userdetailid\nwhen matched then update\nset pp.campaigns = 'yourpurina';\n\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'PDC Table Creation',\n    'SCRIPT',\n    'FINISHED';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196983":{"id":196983,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[196987],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"196980":{"id":196980,"sourceID":196982,"targetID":196981}},"failureConnectors":{},"unconditionalConnectors":{"196987":{"id":196987,"sourceID":196983,"targetID":196982}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"Daily PDC Output","description":null,"type":"ORCHESTRATION","tag":"84953409-3e08-4102-9d0f-7dc51c1928cf"}}