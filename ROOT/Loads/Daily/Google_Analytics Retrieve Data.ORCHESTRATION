{"job":{"components":{"196324":{"id":196324,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-768,"y":-144,"width":32,"height":32,"inputConnectorIDs":[196331],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Map to DB"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*\nTranslate raw GA data into db table\n*/\n\nmerge into ${Database}.db.${GA_Table_Name} db\nusing\n(select  \t     \n    \"Date\" as Date, \n    \"EventCategory\" as EventCategory, \n    \"EventAction\" as EventAction, \n    \"EventLabel\" as EventLabel, \n    max(\"AvgEventValue\") as AvgEventValue,\n    max(\"TotalEvents\") as TotalEvents,\n    split_part(\"Dimensions\",',',1) as GigyaID,  \n    split_part(\"Dimensions\",',',2) as GASource_Medium,\n    ${View_Id} as View_id, \n    to_date('${Start_Date}') as DownloadDate \nfrom ${Database}.staging.ga_gigya_source\ngroup by 1,2,3,4,7,8,9,10) stg\non stg.View_id = db.View_id\n   and stg.GigyaID = db.GigyaID\n   and stg.Date = db.Date\n   and stg.EventCategory = db.EventCategory\n   and stg.EventAction = db.EventAction\n   and stg.EventLabel = db.EventLabel\n   and stg.GASource_Medium = db.GASource_Medium\nwhen matched and stg.DownloadDate > db.DownloadDate then \nupdate \nset           \n\tAvgEventValue \t= stg.AvgEventValue,\n    TotalEvents\t\t= stg.TotalEvents,\n    DownloadDate\t= stg.DownloadDate\nwhen not matched then \ninsert (     \n    Date, \n    EventCategory, \n    EventAction, \n    EventLabel, \n    AvgEventValue,\n    TotalEvents,\n    GigyaID,  \n    GASource_Medium,\n    View_id, \n    DownloadDate ) \nvalues (     \n    stg.Date, \n    stg.EventCategory, \n    stg.EventAction, \n    stg.EventLabel, \n    stg.AvgEventValue,\n    stg.TotalEvents,\n    stg.GigyaID,  \n    stg.GASource_Medium,\n    stg.View_id, \n    stg.DownloadDate )\n;\n\n\n--update last download date\nupdate ${Database}.staging.GA_Brand_Download_dates dd\nset\n    last_download_date = Max_Date\nfrom  (select view_id, max(Date) as Max_Date from ${Database}.db.${GA_Table_Name} group by 1) gs\nwhere dd.view_id = gs.view_id\n\tand dd.view_id = ${View_Id}\n;    \n\n--insert new unconfirmed lookup values\nmerge into ${Database}.db.GASource_Medium_Lookup sm\nusing\n(select distinct \t     \n    split_part(\"Dimensions\",',',2) as GASource_Medium\nfrom ${Database}.staging.ga_gigya_source) stg\non stg.GASource_Medium = sm.GASource_Medium\nwhen not matched then \ninsert (     \n    GASource_Medium, \n    GASource, \n    GASource_simple, \n    Medium, \n    Reporting_Name,\n    Created_Date,\n\tConfirmed\n\t) \nvalues (     \n    stg.GASource_Medium, \n    initcap(tbw.db.strchop(stg.GASource_Medium,'/',1,1)), \n    initcap(case \n                    when substring(tbw.db.strchop(stg.GASource_Medium,'/',1,1),1,7) like '%.%.%' and len(tbw.db.strchop(stg.GASource_Medium,'/',1,1)) > 10 then tbw.db.strchop(tbw.db.strchop(stg.GASource_Medium,'/',1,1),'.',3,3) \n                    when substring(tbw.db.strchop(stg.GASource_Medium,'/',1,1),1,7) like '%.%'   and len(tbw.db.strchop(stg.GASource_Medium,'/',1,1)) > 10 then tbw.db.strchop(tbw.db.strchop(stg.GASource_Medium,'/',1,1),'.',2,2) \n                    else tbw.db.strchop(tbw.db.strchop(stg.GASource_Medium,'/',1,1),'.',1,1) \n                  end), \n    initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2)), \n    case \n  \t\twhen trim(initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2))) in ('Display','Email','Referral') then trim(initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2)))\n  \t\twhen trim(initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2))) ilike 'paid%social' then 'Paid social'\n  \t\twhen trim(initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2))) ilike '%organic%' then 'Organic social'\n  \t\twhen trim(initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2))) ilike '%social%' then 'Organic social'\n  \t\twhen trim(initcap(tbw.db.strchop(stg.GASource_Medium,'/',2,2))) = 'Qr' then 'QR'\n  \t\telse 'Unknown'\n  \tend,\n    current_date, \n    0 )\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196325":{"id":196325,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-1104,"y":-144,"width":32,"height":32,"inputConnectorIDs":[196328],"outputSuccessConnectorIDs":[196330],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate Staging Table"}}}},"visible":true},"3":{"slot":3,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"4":{"slot":4,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STAGING"}}}},"visible":true},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${ga_table_name}"}}}},"visible":true},"6":{"slot":6,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196326":{"id":196326,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-454427654,"x":-944,"y":-144,"width":32,"height":32,"inputConnectorIDs":[196330],"outputSuccessConnectorIDs":[196331],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Event and Gigya ID"}}}},"visible":true},"2":{"slot":2,"name":"Basic/Advanced Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Basic"}}}},"visible":true},"3":{"slot":3,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Nestle GA New Connection"}}}},"visible":true},"6":{"slot":6,"name":"Data Source","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Events"}}}},"visible":true},"7":{"slot":7,"name":"Data Selection","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Date"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"EventCategory"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"EventAction"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"EventLabel"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"Dimensions"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"AvgEventValue"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"TotalEvents"}}}},"visible":true},"8":{"slot":8,"name":"Data Source Filter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Dimensions"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"dimension49,SourceMedium"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"StartDate"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"'${Start_Date}'"}}}},"visible":true},"9":{"slot":9,"name":"Combine Filters","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true},"10":{"slot":10,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT ..."}}}},"visible":false},"11":{"slot":11,"name":"Limit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"12":{"slot":12,"name":"Connection Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Profile"},"2":{"slot":2,"type":"STRING","value":"${View_Id}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"DefaultFilter"},"2":{"slot":2,"type":"STRING","value":"Dimensions=ga:dimension49"}}}},"visible":true},"13":{"slot":13,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${Database}"}}}},"visible":true},"14":{"slot":14,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STAGING"}}}},"visible":true},"15":{"slot":15,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${GA_Table_Name}"}}}},"visible":true},"16":{"slot":16,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"17":{"slot":17,"name":"S3 Staging Area","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${Bucket}"}}}},"visible":true},"18":{"slot":18,"name":"Primary Keys","elements":{},"visible":true},"20":{"slot":20,"name":"Data Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"100":{"slot":100,"name":"API","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Google Universal Analytics"}}}},"visible":true},"1001":{"slot":1001,"name":"","elements":{},"visible":false},"1013":{"slot":1013,"name":"Auto Debug","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Off"}}}},"visible":true},"1014":{"slot":1014,"name":"Debug Level","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"3"}}}},"visible":false},"1992":{"slot":1992,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1993":{"slot":1993,"name":"Use Accelerated Endpoint","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"1994":{"slot":1994,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"1995":{"slot":1995,"name":"Stage Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1996":{"slot":1996,"name":"Stage Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1997":{"slot":1997,"name":"New Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"1998":{"slot":1998,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1999":{"slot":1999,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"2000":{"slot":2000,"name":"Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Standard"}}}},"visible":true},"40000":{"slot":40000,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"40001":{"slot":40001,"name":"KMS Key ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"40501":{"slot":40501,"name":"","elements":{},"visible":false},"40502":{"slot":40502,"name":"Load Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"On"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"Off"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"Off"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":""}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"On"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"Gzip"}}}},"visible":true},"63319":{"slot":63319,"name":"Stage Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Credentials"}}}},"visible":false},"63320":{"slot":63320,"name":"Storage Account","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"63321":{"slot":63321,"name":"Blob Container","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"63322":{"slot":63322,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"84533":{"slot":84533,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"88340":{"slot":88340,"name":"","elements":{},"visible":false},"88341":{"slot":88341,"name":"Stage Platform","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Existing Amazon S3 Location"}}}},"visible":true},"88342":{"slot":88342,"name":"Stage Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Credentials"}}}},"visible":true},"88343":{"slot":88343,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"88344":{"slot":88344,"name":"Use Accelerated Endpoint","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"88345":{"slot":88345,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"98776":{"slot":98776,"name":"GCS Staging Area","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196327":{"id":196327,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-1264,"y":-144,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[196328],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"196330":{"id":196330,"sourceID":196325,"targetID":196326},"196331":{"id":196331,"sourceID":196326,"targetID":196324}},"failureConnectors":{},"unconditionalConnectors":{"196328":{"id":196328,"sourceID":196327,"targetID":196325}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"196321":{"id":196321,"x":-1332,"y":-267,"width":250,"height":58,"text":"Do not run this stand alone - when run with nothing in parameters it will still extract data but will select the 'first' (seemingly random) profile so you wont get the data expected.\n\nIf you set the variables it will stop the looper working due to override hierarchy\n\nThis should generally be run from the download looper with the view ids passed in","colour":"e6e63c"}},"variables":{"GA_Table_Name":{"definition":{"name":"GA_Table_Name","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"GA_GIGYA_SOURCE"},"Start_Date":{"definition":{"name":"Start_Date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":null},"View_Id":{"definition":{"name":"View_Id","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":null}},"grids":{}},"info":{"name":"Google_Analytics Retrieve Data","description":"","type":"ORCHESTRATION","tag":"b37fc1d7-2094-4ddb-9ffb-05c0c56021b9"}}