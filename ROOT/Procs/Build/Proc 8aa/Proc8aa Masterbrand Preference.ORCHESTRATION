{"job":{"components":{"197212":{"id":197212,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-384,"y":-32,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[197218],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197219":{"id":197219,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-187,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197218],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Proc 8aa Masterbrand Preference"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nKognitio Program  : Nestle Masterbrand Preference Code Proc 8aa\nAuthor            : Shira Middleton\nClient Name       : Nestle\nJob Number        : NIM09674\nStandard Machine  : Snowflake\nAmendment History : v01 - SM 20221004 - Created\n******************************************************************************************/\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect \tcurrent_timestamp::timestamp_ntz\n, \t\t'${Database}'\n,\t\t'BUILD'\n,\t\t'Proc 8aa Masterbrand Preference'\n, \t\t'SCRIPT'\n, \t\t'STARTED'\n;\n\n/******************************************************************************************\n                                     MASTERBRAND PREFERENCE CREATION\n******************************************************************************************/\n\n--select all records of the brands within masterbrand that should be used for consideration\ncreate or replace table ${Database}.temp.pref_masterbrand_all\nas\nselect np.*, rb.masterbrand_id from ${Database}.db.names_preference np\nleft join ${Database}.db.ref_brand rb on np.brand_id = rb.brand_id\nwhere np.brand_id in (select brand_id from ${Database}.db.ref_brand where masterbrand_id is not null)\n;\n\n--get the latest record per brand and then create the masterbrand record from that.\ncreate or replace table ${Database}.temp.pref_masterbrand_latest\nas\nselect latest_name_urn as name_urn, latest_data_controller_id as data_controller_id, latest_division_id as division_id, \nrm.brand_id as brand_id,\nmax(latest_data_date) as data_date, max(latest_pref_id) as pref_id, \nmax(latest_pref_mailable) as pref_mailable, max(latest_pref_emailable) as pref_emailable, max(latest_pref_phoneable) as pref_phoneable, \nmax(latest_pref_smsable) as pref_smsable, 'Masterbrand_pref_update' as source, 'Masterbrand_pref_update' as source_file, max(latest_source_urn) as source_urn, current_date() as source_date\nfrom ( select distinct\n        last_value(pma.name_urn) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_name_urn,\n        last_value(pma.data_controller_id) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_data_controller_id,\n        last_value(pma.division_id) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_division_id,   \n        last_value(pma.brand_id) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_brand_id,\n        last_value(pma.data_date) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_data_date,\n        last_value(pma.pref_id) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_pref_id,\n        last_value(pma.pref_mailable) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_pref_mailable,\n        last_value(pma.pref_emailable) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_pref_emailable,\n        last_value(pma.pref_phoneable) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_pref_phoneable,\n        last_value(pma.pref_smsable) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_pref_smsable,\n        last_value(pma.source) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_source,\n        last_value(pma.source_file) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_source_file,\n        last_value(pma.source_urn) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_source_urn,\n        last_value(pma.source_date) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_source_date,\n        last_value(pma.masterbrand_id) over (partition by xr.cid, pma.brand_id order by pma.data_date, pma.source_date) as latest_masterbrand_id\n  from ${Database}.temp.pref_masterbrand_all pma\n      join ${Database}.live.xref_name_urn xr on pma.name_urn = xr.name_urn\n  ) lpma\n  join ${Database}.db.ref_masterbrand rm on lpma.latest_masterbrand_id = rm.masterbrand_id\n  group by 1,2,3,4\n  ;\n\n--insert the masterbrand record where it does not already exist or is different to the latest preference within the names_preference table  \n insert into ${Database}.db.names_preference\n select pml.name_urn, pml.data_controller_id, pml.division_id, pml.brand_id, pml.data_date, pml.pref_id, pml.pref_mailable,\n    pml.pref_emailable, pml.pref_phoneable, pml.pref_smsable, pml.source, pml.source_file, pml.source_urn, pml.source_date\n    from ${Database}.temp.pref_masterbrand_latest pml\n    left join ( select distinct\n        last_value(np.name_urn) over (partition by xr.cid, np.brand_id order by np.data_date, np.source_date) as latest_name_urn,\n        last_value(np.brand_id) over (partition by xr.cid, np.brand_id order by np.data_date, np.source_date) as latest_brand_id,\n        last_value(np.pref_emailable) over (partition by xr.cid, np.brand_id order by np.data_date, np.source_date) as latest_pref_emailable\n  from ${Database}.db.names_preference np\n      join ${Database}.live.xref_name_urn xr on np.name_urn = xr.name_urn\n      where np.brand_id in (select brand_id from ${Database}.db.ref_masterbrand)\n  ) lpma on pml.name_urn = lpma.latest_name_urn and pml.brand_id = lpma.latest_brand_id and pml.pref_emailable = lpma.latest_pref_emailable\n  where lpma.latest_name_urn is null\n  ;\n  \n  /******************************************************************************************\n                                      Finish proc\n******************************************************************************************/\n\ninsert into ${Database}.db.build_log \nselect \n    'nestle_masterbrand_preference',\n    '*************************',\n    '*************************',\n    'end of script',\n    CURRENT_TIMESTAMP::timestamp_ntz ;  \n\n\ninsert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect \tcurrent_timestamp::timestamp_ntz\n, \t\t'${Database}'\n,\t\t'BUILD'\n,\t\t'Proc 8aa Masterbrand Preference'\n, \t\t'SCRIPT'\n, \t\t'FINISHED'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"197218":{"id":197218,"sourceID":197212,"targetID":197219}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"Proc8aa Masterbrand Preference","description":"updating the preference for all of the masterbrand brands.","type":"ORCHESTRATION","tag":"98e14898-a303-418f-8c81-3cce1e0a468f"}}