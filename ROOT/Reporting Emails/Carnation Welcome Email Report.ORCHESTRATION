{"job":{"components":{"196720":{"id":196720,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[196724],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196726":{"id":196726,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":1841964130,"x":336,"y":0,"width":32,"height":32,"inputConnectorIDs":[196725],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Carnation Verification Report Email"}}}},"visible":true},"2":{"slot":2,"name":"from","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto@blueberrywave.com"}}}},"visible":true},"3":{"slot":3,"name":"from_name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${Database}"}}}},"visible":true},"4":{"slot":4,"name":"html_body","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${email_body}"}}}},"visible":true},"5":{"slot":5,"name":"subject","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Carnation Welcome Emails Report"}}}},"visible":true},"6":{"slot":6,"name":"text_body","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"This is text body of email"}}}},"visible":true},"7":{"slot":7,"name":"to","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${CarnationVerificationList}"}}}},"visible":true},"8":{"slot":8,"name":"bcc","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":" "}}}},"visible":true},"9":{"slot":9,"name":"cc","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":" "}}}},"visible":true},"10":{"slot":10,"name":"replyto","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto@blueberrywave.com"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"196727":{"id":196727,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1032749985,"x":160,"y":0,"width":32,"height":32,"inputConnectorIDs":[196724],"outputSuccessConnectorIDs":[196725],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Table For Carnation Report Email"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select \n'<html>'\n||'<style>'\n||'th,'\n||'td {font-family: arial; font-size: 9pt; border: 1px inset;},'\n||'table {font-family: arial; font-size: 9pt; border: 1px outset;}'\n||'</style>'\n||'<head><head>'\n||'<body style = \"font-family: arial; font-size: 9pt;\">'\n||'<h1 style = \"font-family: arial; font-size: 24pt;\">Carnation Welcome Emails Report</h1>'\n||'<h3 style = \"font-family: arial; font-size: 13.5pt;\">Below are the results for the Carnation Welcome Emails.</h3>'\n|| 'Please note data is pulled at the end of each day so results from current morning will not be available.</br></br>'\n|| '<table style=\"width:100%\"><tr style=\"background-color:#95C11F; color:#FFFFFF\"><th>Carnation Welcome Emails</th><th>Sent</th><th>Delivered</th><th>Delivered %</th><th>Opened</th><th>Opened %</th><th>Clicked</th><th>CTO %</th><th>CTR %</th>'\n|| listagg(\n              '<tr>'\n              ||'<td style=\"width:20%; text-align: left; vertical-align: middle; color:#FFFFFF; font-weight:bold; background-color:#95C11F;\">'||case when date_sent is null then 'Total' else to_char(date_sent) end||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||sent||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||delivered||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||delivered_perc||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||opened||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||opened_perc||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||clicked||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||clicked_opened_perc||'</td>'\n              ||'<td style=\"width:8%; text-align: right; vertical-align: middle; color:#464749\">'||clicked_delivered_perc||'</td>'\n              ||'</tr>',\n              ' '\n          )\n   WITHIN GROUP ( order by sent_date desc nulls last )\n|| '</table>'\n|| '</br></br>Please do not reply to this email as it comes from an automated account.</br></br>Thanks</body></html>'\nas email_body\nfrom (\n         select sent_date,\n             case when month(sent_date) = month(current_date-1) and year(sent_date) = year(current_date-1) then to_varchar(sent_date,'DD/MM/YYYY')\n             else to_varchar(monthname(sent_date))||' '||to_varchar(year(sent_date)) end as date_sent,\n             sum(sent) as sent,\n             sum(case when sent = 1 and bounced = 0 then 1 else 0 end) as delivered,\n             cast(sum(case when sent = 1 and bounced = 0 then 1 else 0 end)/sum(sent)*100 as decimal(16,2)) as delivered_perc,\n             sum(opened) as opened,\n             cast(sum(opened)/sum(case when sent = 1 and bounced = 0 then 1 else 0 end)*100 as decimal(16,2)) as opened_perc,\n             sum(clicked) as clicked,\n             case when sum(opened) = 0 then 0 else cast(sum(clicked)/sum(opened)*100 as decimal(16,2)) end as clicked_opened_perc,\n             cast(sum(clicked)/sum(case when sent = 1 and bounced = 0 then 1 else 0 end)*100 as decimal(16,2)) as clicked_delivered_perc\n         from (\n                  select\n                      name_urn,\n                      min(case when event_name = 'sent_campaign' and month(cast(event_timestamp as date)) = month(current_date-1) and year(cast(event_timestamp as date)) = year(current_date-1) then cast(event_timestamp as date) \n                               when event_name = 'sent_campaign' and (month(cast(event_timestamp as date)) <> month(current_date-1) or year(cast(event_timestamp as date)) <> year(current_date-1)) then date_trunc('MONTH',cast(event_timestamp as date))\n                          end) as sent_date,\n                      max(case when event_name = 'sent_campaign' then 1 else 0 end) as sent,\n                      max(case when event_name ilike any ('%inbound_bounce%','%inbound_domain%','%inbound_quota%','%inbound_user%') then 1 else 0 end) as bounced,\n                      max(case when event_name ilike any ('%read%','%click%') then 1 else 0 end) as opened,\n                      max(case when event_name ilike '%click%' then 1 else 0 end) as clicked\n                  from ${Database}.db.adestra_events\n                  where campaign_name = 'NUK09585_Carnation_Welcome' \n                  group by 1\t\t\t  \n              ) a\n         where sent_date is not null\n         group by rollup (sent_date)\n     ) a"}}}},"visible":true},"3":{"slot":3,"name":"Scalar Variable Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"email_body"},"2":{"slot":2,"type":"STRING","value":"EMAIL_BODY"}}}},"visible":true},"4":{"slot":4,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"6":{"slot":6,"name":"Table Columns","elements":{},"visible":false},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"10":{"slot":10,"name":"Limit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"100"}}}},"visible":false},"11":{"slot":11,"name":"Order By","elements":{},"visible":false},"12":{"slot":12,"name":"Sort","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Ascending"}}}},"visible":false},"13":{"slot":13,"name":"Filter Conditions","elements":{},"visible":false},"14":{"slot":14,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":false},"20":{"slot":20,"name":"Basic / Advanced","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Advanced"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"196725":{"id":196725,"sourceID":196727,"targetID":196726}},"failureConnectors":{},"unconditionalConnectors":{"196724":{"id":196724,"sourceID":196720,"targetID":196727}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"campaign_check":{"definition":{"name":"campaign_check","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"email_body":{"definition":{"name":"email_body","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"Carnation Welcome Email Report","description":"","type":"ORCHESTRATION","tag":"c73e045d-a600-4857-b64a-a81b3888000e"}}