{"job":{"components":{"197308":{"id":197308,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-128,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197318],"outputSuccessConnectorIDs":[197319],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy to S3"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'SFMC',\n    'SFMC Children copy to s3',\n    'STARTED';\n\n\ncopy into 's3://${Bucket}/sfmc/from_bbw/children_${sfmc_file_date.now().format(\"dd_MM_yyyy\")}.csv'\nfrom (select distinct \nBBW_URN,\nBRAND_BBW_URN,\nCHILD_URN,\nCHILD_ID,\nFIRSTNAME,\nLASTNAME,\nDOB,\nGENDER,\nAUTO_PROMOTED,\nCHILD_NAME,\nCOMMS_PROGRAMME,\nCOMMS_SUBPROGRAMME,\nCOMMS_PROGRAMME_DESCRIPTION,\nCOMMS_DUEDATE,\nLIVE_FLAG,\nCHILD_STAGE_REG,\nCHILD_STAGE_NOW,\nVALID,\nSOURCE,\nSOURCE_DATE,\nCREATED_DATE\nfrom ${Database}.db.sfmc_children_extract)\nstorage_integration = ${Database}_S3_SI\nfile_format = (type=CSV\ncompression = NONE\nRECORD_DELIMITER='\\r\\n',\nFIELD_DELIMITER=',',\nFIELD_OPTIONALLY_ENCLOSED_BY = '\"',\nDATE_FORMAT='YYYY-MM-DD',\nTIME_FORMAT='HH:NN:SS',\nTIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\nEMPTY_FIELD_AS_NULL = FALSE,\nNULL_IF=(''),\nENCODING='UTF8')\noverwrite = TRUE\nsingle = TRUE\nheader = TRUE\nMAX_FILE_SIZE=5368709120\n;\n\n/*\n    Log rows selected for export--children\n*/\ninsert into ${Database}.db.SFMC_extracts_daily_counts_log\n(\n  select \n    'copy to s3 - table count',\n    current_date,\n    current_timestamp,\n    'children_'||TO_CHAR(current_date(),'DD_MM_YYYY')||'.csv',\n    count(*)\nfrom ${Database}.db.sfmc_children_extract\n);"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197312":{"id":197312,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-400,"y":-32,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[197316,197317],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197313":{"id":197313,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-16,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197319],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log End"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC CHILDREN EXTRACT'\n,'END'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197314":{"id":197314,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-400,"y":96,"width":32,"height":32,"inputConnectorIDs":[197317],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log Start"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC CHILDREN EXTRACT'\n,'START'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197315":{"id":197315,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-272,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197316],"outputSuccessConnectorIDs":[197318],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Create view for Children extract - sfmc_children_extract"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nProgram           : SFMC Children\nAuthor            : Mark Webb\nClient Name       : Nestle\nStandard Machine  : Snowflake\nAmendment History : v01 - CB 20220718 - Created\n******************************************************************************************/\n\n\n--Not using the Brand Extract Lookup as this is specific to SMA Only\ncreate or replace table ${Database}.db.sfmc_children_extract \nas\nselect distinct\nb.bbw_urn,\nconcat(b.bbw_urn,'-',(select brand_id from ${Database}.db.ref_brand where brand = 'SMA')) as brand_bbw_urn,\na.child_urn,\na.child_id,\na.firstname,\na.lastname,\na.dob,\na.gender,\na.auto_promoted,\na.child_name,\na.comms_programme,\na.comms_subprogramme,\na.comms_programme_description,\na.comms_duedate,\na.live_flag,\na.child_stage_reg,\na.child_stage_now,\na.valid,\na.source,\na.source_date,\na.created_date\nfrom ${Database}.live.dependant a\njoin ${Database}.live.xref_name_urn b\non a.cid = b.cid and a.source = b.source\nand b.bbw_urn in (select bbw_urn from ${Database}.db.consumer_brand_daily_extract)\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"197318":{"id":197318,"sourceID":197315,"targetID":197308},"197319":{"id":197319,"sourceID":197308,"targetID":197313}},"failureConnectors":{},"unconditionalConnectors":{"197316":{"id":197316,"sourceID":197312,"targetID":197315},"197317":{"id":197317,"sourceID":197312,"targetID":197314}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"SFMC Children Extract","description":"","type":"ORCHESTRATION","tag":"13e8c5b9-9c85-4cf6-aa2a-47f65452fab7"}}