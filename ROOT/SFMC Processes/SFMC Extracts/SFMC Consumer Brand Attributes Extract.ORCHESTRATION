{"job":{"components":{"197320":{"id":197320,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":16,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197330],"outputSuccessConnectorIDs":[197325],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Consumer Brand Attributes Extract"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nProgram           : SFMC Consumer Brand Attributes\nAuthor            : Mark Webb\nClient Name       : Nestle\nStandard Machine  : Snowflake\nAmendment History : v01 - CB 20220718 - Created\n******************************************************************************************/\n\ncreate or replace view ${Database}.db.sfmc_adestra_events_build as\nselect\ndistinct\nx.bbw_urn,\nconcat(x.bbw_urn,'-',ch.data_brand_id) as brand_bbw_urn,\nch.data_brand_id as brand_id,\nae.campaign_id as adestra_campaign_id,\nae.campaign_name as adestra_campaign_name,\nevent_name,\nevent_timestamp,\nlink_label,\nlink_url,\nform_builder_id,\nchl.programme_description,\nch.campaign_id,\nchl.campaign_description,\nch.promotion_id,\nchl.promotion_description,\nch.cell_id,\nchl.cell_description,\nch.pack_id,\nchl.pack_description,\nchl.control\nfrom ${Database}.db.adestra_events ae\njoin ${Database}.live.xref_name_urn x on x.name_urn = ae.name_urn\njoin ${Database}.db.comms_hist ch on ae.kog_pack = ch.programme_id||'|'||ch.campaign_id||'|'||ch.promotion_id||'|'||ch.cell_id||'|'||ch.pack_id and ch.name_urn = ae.name_urn and ch.email = ae.email\njoin ${Database}.db.comms_hist_lookup chl on ae.kog_pack = chl.programme_id||'|'||chl.campaign_id||'|'||chl.promotion_id||'|'||chl.cell_id||'|'||chl.pack_id\nwhere ch.data_brand_id in (select brand_id from ${Database}.db.sfmc_brand_extract_lookup)\nand left(event_timestamp,10)  >= '2020-01-01';\n\ncreate or replace view ${Database}.db.sfmc_brand_question_build as\nselect \nb.bbw_urn,\nconcat(b.bbw_urn,'-',a.brand_id) as brand_bbw_urn,\nbrand_id,\nquestion_id,\nanswer,\nanswer_data_date\nfrom ${Database}.live.cid_brand_question a\njoin ${Database}.live.xref_name_urn b\non a.cid = b.cid\nwhere question_id in (select question_id from ${Database}.db.sfmc_question_id_extract_lookup);\n\ncreate or replace view ${Database}.db.sfmc_reg_campaign_build as\nselect \ndistinct\nb.bbw_urn,\nconcat(b.bbw_urn,'-',b.source_brand_id) as brand_bbw_urn,\nsource_brand_id as brand_id,\nregistration_campaign\nfrom ${Database}.db.names_attributes a\njoin ${Database}.live.names b\non a.name_urn = b.name_urn\nwhere b.source_brand_id in (select brand_id from ${Database}.db.sfmc_brand_extract_lookup);\n\ncreate or replace table ${Database}.db.sfmc_brand_attributes_output (\nbbw_urn NUMBER(38,0),\nbrand_bbw_urn varchar(50),\nbrand NUMBER(38,0),\nquestion_id NUMBER(38,0),\nanswer varchar(255),\nanswer_data_date date,\nadestra_campaign_id VARCHAR(200),\nadestra_campaign_name VARCHAR(200),\nevent_name VARCHAR(200),\nevent_timestamp TIMESTAMP_NTZ(6),\nlink_label VARCHAR(200),\nlink_url VARCHAR(1000),\nform_builder_id VARCHAR(50),\nprogramme_description VARCHAR(100),\ncampaign_id VARCHAR(20),\ncampaign_description VARCHAR(100),\npromotion_id VARCHAR(20),\npromotion_description VARCHAR(100),\ncell_id VARCHAR(100),\ncell_description VARCHAR(100),\npack_id VARCHAR(50),\npack_description VARCHAR(255),\ncontrol VARCHAR(10),\nregistration_campaign VARCHAR(100)\n);\n\ninsert into ${Database}.db.sfmc_brand_attributes_output \n(\nbbw_urn,\nbrand_bbw_urn,\nbrand,\nquestion_id,\nanswer,\nanswer_data_date\n)\nselect\nbbw_urn,\nbrand_bbw_urn,\nbrand_id,\nquestion_id,\nanswer,\nanswer_data_date\nfrom ${Database}.db.sfmc_brand_question_build\nwhere bbw_urn in (select bbw_urn from ${Database}.db.consumer_brand_daily_extract);\n\n\ninsert into ${Database}.db.sfmc_brand_attributes_output \n(bbw_urn,\nbrand_bbw_urn,\nbrand,\nregistration_campaign\n)\nselect\nbbw_urn,\nbrand_bbw_urn,\nbrand_id,\nregistration_campaign\nfrom ${Database}.db.sfmc_reg_campaign_build\nwhere bbw_urn in (select bbw_urn from ${Database}.db.consumer_brand_daily_extract)\nand registration_campaign is not null;\n\nalter warehouse set warehouse_size = 'large';\n\ninsert into ${Database}.db.sfmc_brand_attributes_output \n(bbw_urn,\nbrand_bbw_urn,\nbrand,\nadestra_campaign_id,\nadestra_campaign_name,\nevent_name,\nevent_timestamp,\nlink_label,\nlink_url,\nform_builder_id,\nprogramme_description,\ncampaign_id,\ncampaign_description,\npromotion_id,\npromotion_description,\ncell_id,\ncell_description,\npack_id,\npack_description,\ncontrol\n)\nselect\nbbw_urn,\nbrand_bbw_urn,\nbrand_id,\nadestra_campaign_id,\nadestra_campaign_name,\nevent_name,\nevent_timestamp,\nlink_label,\nlink_url,\nform_builder_id,\nprogramme_description,\ncampaign_id,\ncampaign_description,\npromotion_id,\npromotion_description,\ncell_id,\ncell_description,\npack_id,\npack_description,\ncontrol\nfrom ${Database}.db.sfmc_adestra_events_build\nwhere bbw_urn in (select bbw_urn from ${Database}.db.consumer_brand_daily_extract);\n\nalter warehouse set warehouse_size = 'xsmall';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197321":{"id":197321,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-128,"y":80,"width":32,"height":32,"inputConnectorIDs":[197331],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log Start"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC CONSUMER ATTRIBUTES EXTRACT'\n,'START'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197322":{"id":197322,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-128,"y":-32,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[197330,197331],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197326":{"id":197326,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":144,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197325],"outputSuccessConnectorIDs":[197324],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3 Output"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'SFMC',\n    'SFMC consumer brand attributes copy to s3',\n    'STARTED';\n    \n    \n    \ncopy into 's3://${Bucket}/sfmc/from_bbw/consumer_brand_attributes_${sfmc_file_date.now().format(\"dd_MM_yyyy\")}.csv'\nfrom (select  *\nfrom ${Database}.db.sfmc_brand_attributes_output)\nstorage_integration = ${Database}_S3_SI\nfile_format = (type=CSV\ncompression = NONE\nRECORD_DELIMITER='\\r\\n',\nFIELD_DELIMITER=',',\nFIELD_OPTIONALLY_ENCLOSED_BY = '\"',\nDATE_FORMAT='YYYY-MM-DD',\nTIME_FORMAT='HH:NN:SS',\nTIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\nEMPTY_FIELD_AS_NULL = FALSE,\nNULL_IF=(''),\nENCODING='UTF8')\noverwrite = TRUE\nsingle = TRUE\nheader = TRUE\nMAX_FILE_SIZE=5368709120\n;\n\n\n\n\n/*\n    insert rows selected for export --consumer brand attributes\n*/\ninsert into ${Database}.db.SFMC_extracts_daily_counts_log\n(\n  select \n    'copy to s3 - table count',\n    current_date,\n    current_timestamp,\n    'consumer_brand_attributes_'||TO_CHAR(current_date(),'DD_MM_YYYY')||'.csv',\n    count(*)\nfrom ${Database}.db.sfmc_brand_attributes_output\n);\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197327":{"id":197327,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":272,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197324],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log End"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC CONSUMER ATTRIBUTES EXTRACT'\n,'END'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"197324":{"id":197324,"sourceID":197326,"targetID":197327},"197325":{"id":197325,"sourceID":197320,"targetID":197326}},"failureConnectors":{},"unconditionalConnectors":{"197330":{"id":197330,"sourceID":197322,"targetID":197320},"197331":{"id":197331,"sourceID":197322,"targetID":197321}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"SFMC Consumer Brand Attributes Extract","description":"","type":"ORCHESTRATION","tag":"585184c7-7071-4c8d-8601-c74bae7e914a"}}