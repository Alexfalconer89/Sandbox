{"job":{"components":{"197364":{"id":197364,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-640,"y":304,"width":32,"height":32,"inputConnectorIDs":[197372],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log Start"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC FILE VALIDATION'\n,'START'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197365":{"id":197365,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-640,"y":192,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[197372,197373],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197366":{"id":197366,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-528,"y":192,"width":32,"height":32,"inputConnectorIDs":[197373],"outputSuccessConnectorIDs":[197368],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Validate files on S3"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n#Program           : SFMC Validation\n#Author            : Chris Bamford\n#Client Name       : Nestle\n#Amendment History : v01 - CB 20220718 - Created\n###\n\nimport boto3, botocore\nimport io\nimport pandas as pd\nfrom io import StringIO\nimport os\nfrom datetime import date\n\n                   \ns3 = boto3.resource('s3')\nfile_list = []\ntoday = date.today()\nmy_bucket = s3.Bucket('${Bucket}')\nfor my_bucket_object in my_bucket.objects.filter(Prefix='sfmc/from_bbw/'):\n\tif '.csv' in my_bucket_object.key and today.strftime(\"%d_%m_%Y\") in my_bucket_object.key and ('attributes_' in my_bucket_object.key \n                                                                                                  or 'children_' in my_bucket_object.key \n                                                                                                  or 'consumer_brand_' in my_bucket_object.key \n                                                                                                  or 'consumer_brand_attributes_' in my_bucket_object.key \n                                                                                                  or 'consumer_brand_transactions_' in my_bucket_object.key \n                                                                                                  or 'litter_' in my_bucket_object.key \n                                                                                                  or 'pet_' in my_bucket_object.key \n                                                                                                  or 'transactions_' in my_bucket_object.key) :\n\t\tfile_list.append(my_bucket_object.key)\nprint(file_list)\n\n\ns3 = boto3.client('s3')\nfor file_ in file_list :\n\tprint(file_)\n\tobj = s3.get_object(Bucket='${Bucket}', Key=file_)\n    ##reading whole file and blanking, will need whole file to count rows or validate header\n\t#df= pd.read_csv(io.BytesIO(obj['Body'].read()))\n\t#print(df)\n\t#csv_buffer = StringIO()\n\t#df.to_csv(csv_buffer,index=False)\n\ts3_resource = boto3.resource('s3')\n\tfile_csv=(file_.replace('.csv','.csv.OK'))\n\ts3_resource.Object('${Bucket}', file_csv).put(Body='')"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197369":{"id":197369,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":620619864,"x":-224,"y":192,"width":32,"height":32,"inputConnectorIDs":[197375],"outputSuccessConnectorIDs":[197374],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Upload All OK file to SFMC SFTP"}}}},"visible":true},"2":{"slot":2,"name":"Source Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3"}}}},"visible":true},"4":{"slot":4,"name":"Target Object Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"nestle_all_files_upload_complete_${sfmc_file_date.now().format(\"dd_MM_yyyy\")}.csv.OK"}}}},"visible":true},"5":{"slot":5,"name":"Target Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SFTP"}}}},"visible":true},"6":{"slot":6,"name":"Set Home Directory as Root","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"7":{"slot":7,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ftp://[username[:password]@]hostname[:port][path]"}}}},"visible":false},"8":{"slot":8,"name":"Source Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"9":{"slot":9,"name":"Source Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"10":{"slot":10,"name":"Source URL","elements":{},"visible":false},"11":{"slot":11,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"hdfs://host:port/filePath"}}}},"visible":false},"12":{"slot":12,"name":"Perform Certificate Validation","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"13":{"slot":13,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"https://[username[:password]@]hostname[:port][absolute-path]"}}}},"visible":false},"14":{"slot":14,"name":"Source Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"15":{"slot":15,"name":"Source Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"16":{"slot":16,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"http://[username[:password]@]hostname[:port][absolute-path]"}}}},"visible":false},"17":{"slot":17,"name":"Source Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"18":{"slot":18,"name":"Source Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"19":{"slot":19,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"s3://${Bucket}/sfmc/from_bbw/"}}}},"visible":true},"20":{"slot":20,"name":"Set Home Directory as Root","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"21":{"slot":21,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"sftp://[username[:password]@]hostname[:port][path]"}}}},"visible":false},"22":{"slot":22,"name":"Source Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"23":{"slot":23,"name":"Source Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"24":{"slot":24,"name":"Source SFTP Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"25":{"slot":25,"name":"Source URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"smb://[[[authdomain;]user@]host[:port][/share[/dirpath][/name]]][?context]"}}}},"visible":false},"26":{"slot":26,"name":"Source Domain","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"27":{"slot":27,"name":"Source Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"28":{"slot":28,"name":"Source Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"29":{"slot":29,"name":"Target URL","elements":{},"visible":false},"30":{"slot":30,"name":"Target URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"hdfs://host:port/filePath"}}}},"visible":false},"31":{"slot":31,"name":"Target URL","elements":{},"visible":false},"33":{"slot":33,"name":"Set Home Directory as Root","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"34":{"slot":34,"name":"Target URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"sftp://mccrh-n6xz6vgd204gcwtkrrqw34.ftp.marketingcloudops.com/import"}}}},"visible":true},"35":{"slot":35,"name":"Target Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"536001455"}}}},"visible":true},"36":{"slot":36,"name":"Target Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":"Nestle SFMC SFTP Access"}}}},"visible":true},"37":{"slot":37,"name":"Target SFTP Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"38":{"slot":38,"name":"Target URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"smb://[[[authdomain;]user@]host[:port][/share[/dirpath][/name]]][?context]"}}}},"visible":false},"39":{"slot":39,"name":"Target Domain","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"40":{"slot":40,"name":"Target Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"41":{"slot":41,"name":"Target Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"42":{"slot":42,"name":"Unpack ZIP file","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"43":{"slot":43,"name":"Gzip data","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"44":{"slot":44,"name":"Access Control List Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"50":{"slot":50,"name":"URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"https://<account>.sharepoint.com"}}}},"visible":false},"51":{"slot":51,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"52":{"slot":52,"name":"Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":""}}}},"visible":false},"53":{"slot":53,"name":"SharePoint Edition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SharePoint Online"}}}},"visible":false},"54":{"slot":54,"name":"File Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Document"}}}},"visible":false},"55":{"slot":55,"name":"Library","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"56":{"slot":56,"name":"File URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"57":{"slot":57,"name":"Connection Options","elements":{},"visible":false},"90":{"slot":90,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"91":{"slot":91,"name":"File ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"93":{"slot":93,"name":"File ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"94":{"slot":94,"name":"Path","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"95":{"slot":95,"name":"Download Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"HTML"}}}},"visible":false},"96":{"slot":96,"name":"Download As Zip","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"97":{"slot":97,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"98":{"slot":98,"name":"File Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"File"}}}},"visible":false},"158":{"slot":158,"name":"Service Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SOAP"}}}},"visible":false},"159":{"slot":159,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"16040":{"slot":16040,"name":"Blob Location","elements":{},"visible":false},"16140":{"slot":16140,"name":"Blob Location","elements":{},"visible":false},"40000":{"slot":40000,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":false},"40001":{"slot":40001,"name":"KMS Key ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197370":{"id":197370,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-400,"y":192,"width":32,"height":32,"inputConnectorIDs":[197368],"outputSuccessConnectorIDs":[197375],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Validation counts and export"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'SFMC',\n    'SFMC validation copy to s3',\n    'STARTED';\n    \n/***\nProgram           : SFMC Validation\nAuthor            : Chris Bamford\nClient Name       : Nestle\nAmendment History : v01 - CB 20220718 - Created\n***/\n\n/*--logging table\ndrop table ${Database}.db.SFMC_extracts_daily_counts_log;\ncreate table ${Database}.db.SFMC_extracts_daily_counts_log\n\n(\n  record_type     varchar(50),\n  event_date       date,\n  event_time      TIMESTAMP,\n  file_name   varchar(50),\n  record_count      NUMBER(38,0)\n)\n;\n*/\n\n\n\n\n/*\n\toutput todays counts\n*/\ncopy into 's3://${Bucket}/sfmc/from_bbw/file_counts_${sfmc_file_date.now().format(\"dd_MM_yyyy\")}.csv'\nfrom (select  \n        distinct      \n        FILE_NAME,\n        EVENT_DATE,\n        first_value(RECORD_COUNT) over (partition by FILE_NAME,EVENT_DATE order by event_time desc) as RECORD_COUNT\n      from ${Database}.db.SFMC_extracts_daily_counts_log\n     where EVENT_DATE = current_date)\n      storage_integration = ${Database}_S3_SI\nfile_format = (\n    type = CSV\n    compression = NONE\n    RECORD_DELIMITER='\\r\\n',\n    FIELD_DELIMITER=',',\n    FIELD_OPTIONALLY_ENCLOSED_BY = '\"'\n    DATE_FORMAT='YYYY-MM-DD',\n    TIME_FORMAT='HH:NN:SS',\n    TIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\n      EMPTY_FIELD_AS_NULL = FALSE,\n    NULL_IF=(''),\n      ENCODING='UTF8'\n    )\noverwrite = TRUE\nsingle = TRUE\nheader = TRUE\nMAX_FILE_SIZE=5368709120;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197371":{"id":197371,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-48,"y":192,"width":32,"height":32,"inputConnectorIDs":[197374],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log End"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC FILE VALIDATION'\n,'END'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"197368":{"id":197368,"sourceID":197366,"targetID":197370},"197374":{"id":197374,"sourceID":197369,"targetID":197371},"197375":{"id":197375,"sourceID":197370,"targetID":197369}},"failureConnectors":{},"unconditionalConnectors":{"197372":{"id":197372,"sourceID":197365,"targetID":197364},"197373":{"id":197373,"sourceID":197365,"targetID":197366}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"SFMC Extract File Validation","description":"creates .csv.OK files where csv files are present in s3 bucket.","type":"ORCHESTRATION","tag":"055e4eab-e603-4a3e-8a22-4332b55ca99d"}}