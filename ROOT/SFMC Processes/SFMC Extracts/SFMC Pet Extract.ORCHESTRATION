{"job":{"components":{"197420":{"id":197420,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-144,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197426],"outputSuccessConnectorIDs":[197425],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy to S3"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'SFMC',\n    'SFMC Pet copy to s3',\n    'STARTED';\n\n\ncopy into 's3://${Bucket}/sfmc/from_bbw/pet_${sfmc_file_date.now().format(\"dd_MM_yyyy\")}.csv'\nfrom (select distinct \n        bbw_urn,\n\t\tbrand_bbw_urn,\n        pet_number,\n        pet_id,\n        pet_type,\n        pet_name,\n        pet_breed,\n        pet_gender,\n        pet_dob,\n        pet_dob_type,\n        pet_size,\n        pet_indoor_outdoor,\n        pet_colour,\n        pet_data_date,\n        pet_life_stage,\n        detailed_pet_segment,\n        pdc_gender_link_update,\n        pdc_breed_link_update,\n        pdc_colour_link_update,\n        pdc_outdoor_link_update,\n        source,\n        pet_type_order,\n        new_pets,\n        cat_1_name,\n        cat_2_name,\n        cat_3_name,\n        dog_1_name,\n        dog_2_name,\n        dog_3_name,\n        cat_1_dob,\n        cat_2_dob,\n        cat_3_dob, \n        dog_1_dob,\n        dog_2_dob,\n        dog_3_dob,\n        cat_1_gender,\n        cat_2_gender,\n        cat_3_gender, \n        dog_1_gender,\n        dog_2_gender,\n        dog_3_gender,\n        cat_1_breed,\n        cat_2_breed,\n        cat_3_breed, \n        dog_1_breed,\n        dog_2_breed,\n        dog_3_breed\nfrom  ${Database}.db.sfmc_cid_pets a\n)\nstorage_integration = ${Database}_S3_SI\nfile_format = (type=CSV\ncompression = NONE\nRECORD_DELIMITER='\\r\\n',\nFIELD_DELIMITER=',',\nFIELD_OPTIONALLY_ENCLOSED_BY = '\"',\nDATE_FORMAT='YYYY-MM-DD',\nTIME_FORMAT='HH:NN:SS',\nTIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\nEMPTY_FIELD_AS_NULL = FALSE,\nNULL_IF=(''),\nENCODING='UTF8')\noverwrite = TRUE\nsingle = TRUE\nheader = TRUE\nMAX_FILE_SIZE=5368709120\n;\n\n\n/*\n    Log rows selected for export--pets\n*/\ninsert into ${Database}.db.SFMC_extracts_daily_counts_log\n(\n  select \n    'copy to s3 - table count',\n    current_date,\n    current_timestamp,\n    'pets_'||TO_CHAR(current_date(),'DD_MM_YYYY')||'.csv',\n    count(*)\nfrom ${Database}.db.sfmc_cid_pets\n);"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197421":{"id":197421,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-400,"y":-32,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[197424,197431],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197422":{"id":197422,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-16,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197425],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log End"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC PET EXTRACT'\n,'END'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197423":{"id":197423,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-400,"y":96,"width":32,"height":32,"inputConnectorIDs":[197424],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log Start"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC PET EXTRACT'\n,'START'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197427":{"id":197427,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-272,"y":-32,"width":32,"height":32,"inputConnectorIDs":[197431],"outputSuccessConnectorIDs":[197426],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Create view for pet output"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nProgram           : SFMC Pet\nAuthor            : Chris Bamford\nClient Name       : Nestle\nStandard Machine  : Snowflake\nAmendment History : v01 - CB 20220718 - Created\n******************************************************************************************/\n\n\n\n--pet names\ndrop view if exists ${Database}.db.sfmc_cid_pets;\ncreate or replace view ${Database}.db.sfmc_cid_pets\nas\nselect distinct\n        cid,\n        bbw_urn,\n        brand_bbw_urn,\n        pet_number,\n        pet_id,\n        pet_type,\n        pet_name,\n        pet_breed,\n        pet_gender,\n        pet_dob,\n        pet_dob_type,\n        pet_size,\n        pet_indoor_outdoor,\n        pet_colour,\n        pet_data_date,\n        pet_life_stage,\n        detailed_pet_segment,\n        new_pets,\n        pdc_gender_link_update,\n        pdc_breed_link_update,\n        pdc_colour_link_update,\n        pdc_outdoor_link_update,\n        source,\n        pet_type_order,\n        case when pet_type = 'Cat' and pet_type_order = 1 then pet_name end as cat_1_name,\n        case when pet_type = 'Cat' and pet_type_order = 2 then pet_name end as cat_2_name,\n        case when pet_type = 'Cat' and pet_type_order = 3 then pet_name end as cat_3_name,\n        case when pet_type = 'Dog' and pet_type_order = 1 then pet_name end   as dog_1_name,\n        case when pet_type = 'Dog' and pet_type_order = 2 then pet_name end   as dog_2_name,\n        case when pet_type = 'Dog' and pet_type_order = 3 then pet_name end   as dog_3_name,\n        case when pet_type = 'Cat' and pet_type_order = 1 then pet_dob end    as cat_1_dob,\n        case when pet_type = 'Cat' and pet_type_order = 2 then pet_dob end    as cat_2_dob,\n        case when pet_type = 'Cat' and pet_type_order = 3 then pet_dob end    as cat_3_dob, \n        case when pet_type = 'Dog' and pet_type_order = 1 then pet_dob end    as dog_1_dob,\n        case when pet_type = 'Dog' and pet_type_order = 2 then pet_dob end    as dog_2_dob,\n        case when pet_type = 'Dog' and pet_type_order = 3 then pet_dob end    as dog_3_dob,\n        case when pet_type = 'Cat' and pet_type_order = 1 then pet_gender end as cat_1_gender,\n        case when pet_type = 'Cat' and pet_type_order = 2 then pet_gender end as cat_2_gender,\n        case when pet_type = 'Cat' and pet_type_order = 3 then pet_gender end as cat_3_gender, \n        case when pet_type = 'Dog' and pet_type_order = 1 then pet_gender end as dog_1_gender,\n        case when pet_type = 'Dog' and pet_type_order = 2 then pet_gender end as dog_2_gender,\n        case when pet_type = 'Dog' and pet_type_order = 3 then pet_gender end as dog_3_gender,\n        case when pet_type = 'Cat' and pet_type_order = 1 then pet_breed end  as cat_1_breed,\n        case when pet_type = 'Cat' and pet_type_order = 2 then pet_breed end  as cat_2_breed,\n        case when pet_type = 'Cat' and pet_type_order = 3 then pet_breed end  as cat_3_breed, \n        case when pet_type = 'Dog' and pet_type_order = 1 then pet_breed end  as dog_1_breed,\n        case when pet_type = 'Dog' and pet_type_order = 2 then pet_breed end  as dog_2_breed,\n        case when pet_type = 'Dog' and pet_type_order = 3 then pet_breed end  as dog_3_breed\nfrom\n    (\n      select distinct\n        cb.cid,\n        cast(tbw.db.strchop(cb.cid_brand_urn,'-',1,1) as int) as bbw_urn,\n        cb.cid_brand_urn as brand_bbw_urn,\n        cp.pet_number,\n        cp.pet_id,\n        cp.pet_type,\n        cp.pet_name,\n        cp.pet_breed,\n        cp.pet_gender,\n        cp.pet_dob,\n        cp.pet_dob_type,\n        cp.pet_size,\n        cp.pet_indoor_outdoor,\n        cp.pet_colour,\n        cp.pet_data_date,\n        cp.pet_life_stage,\n        case when c.have_cat = 'Y' and c.have_dog = 'Y' then 'Known Both'\n             when c.have_cat = 'N' and c.have_dog = 'Y' then 'Known Dog'\n             when c.have_cat = 'Y' and c.have_dog = 'N' then 'Known Cat'\n             when c.have_cat in ('IN','IO') and c.have_dog = 'Y' then 'Known Dog and Inferred Cat'\n             when c.have_cat = 'Y' and c.have_dog in ('IN','IO') then 'Known Cat and Inferred Dog'\n             when c.have_cat in ('IN','IO') and c.have_dog in ('IN','IO') then 'Inferred Both'\n             when c.have_cat in ('IN','IO') and c.have_dog = 'N' then 'Inferred Cat'\n             when c.have_cat = 'N' and c.have_dog in ('IN','IO') then 'Inferred Dog'\n             when c.have_cat = 'N' and c.have_dog = 'N' then 'Unknown'\n             else 'error'\n            end as detailed_pet_segment,\n        cp.new_pets,\n        cp.pdc_gender_link_update,\n        cp.pdc_breed_link_update,\n        cp.pdc_colour_link_update,\n        cp.pdc_outdoor_link_update,\n        cp.source,\n        row_number() over (partition by cp.cid, pet_type order by pet_data_date desc, pet_name asc) as pet_type_order -- decide ordering\n    from ${Database}.live.cid_brand cb\n    join ${Database}.live.ref_brand rb on cb.brand_id = rb.brand_id\n    join ${Database}.live.cid_pet cp on cp.cid = cb.cid\n    join ${Database}.live.cid c on c.cid = cb.cid\n    where BUSINESS_UNIT_ID = 5\n      and brand_campaignable = 1\n      and case when cp.pet_name in (' Years Old','Years Old','0Atis','0Liver','0Lly','0Pel','0Scar','0Z','1 Max. 2 Pippa','1 Poppy 2 Dottie','1. Vasska 2. Sherman','10 Years','12 Cats', --manually suppress bad names as per email from CR\n                                  '14 Others','15 Boy','1Sheba','2 Cats  Barry','2 Cats  Demi','2 Catsbrahma','2 Dogs','2 Dogs  Coco','2 Dogs Coco','2 Honey','2 Kerry','2 S','2 Siamese Cats Jasmin',\n                                  '2 X Dogs Star','3 Cats','3 Cats Eve','3 Cats Oldest Garfield','3 Jack','3 Moggie','3 Others','3 S','34C25','3D','3Hree','4 Cats','4 Cats Bingo','5 Cats','5 Kittens',\n                                  '6 Cats  Lucy','7Even','8 Cats Owned','9Yrs','''Bea', 'Bertha Simmering Light','Cant Name Them Yet','Cat 1','Cat 2','Cat 3','Cat 4','Cat A','Cat Name','Cat1',\n                                  'Cat1 Tom','Cat12','Cat13','Cat1Bentley','Cat2','Cat3','''Cea','''Cooper'' Magic Pulse','Do Not Have One','Dog 1','Dog 2','Dog 3','Dog 4','Dog 5','Dog1','Dog11','Dog2','Dog3',\n                                  'Dont Have Any','Dont Have Names Yet','Dont Have One','Don''t Know','Dont Know Yet','Don''t Know Yet','''Dre','Dunno','Dunno Yet','Éva','Gaylord','Have 5 Cats','Have 6 Cats',\n                                  'Have Not Named Them','Havent Chosen Yet','Havent Named Them','Havent Named Yet','I Have 11','I Have 2 Maisie','I Have 2 Micky','I Have 3 Cats','I Have 3 Twinkle',\n                                  'I Have 4 Cats','I Have 5','I Have 5 Cats','I Have 5 Cat''s','I Have Lots','I Have Six Molly','I Havent Got One','Ive Got 24 Cats','I''ve Got 4 Cats','Ive Got 6 Mia',\n                                  'Just Born','Just Born2','''Kc''','No Cat','No Idea','No Kittens','No More','No.1','No.2','No1 No2 No3 No','Not Given Yet','Not Got Adult',\n                                  'Not Keeping','Not Named','Not Named As Yet','Not Named Her Yet','Not Picked On Yet','Not Sure','Not Sure New Kitten','Not Sure Yet','Not Yet','Not Yet Chose One',\n                                  'Not Yey Named','Nothing Yet','''Olly','Only 1 Dog','Out Door Cat','Pup1','Pup2','Pup3','Puppies 10','Puppies X 10','Puppy 1','Puppy 2','Puppy 3','Puss 1','Puss 2',\n                                  'Still Thinking Of Name','Still To Name Them','\uD83C\uDF40 Clover',\n                                  '..Non Existent..','2 Being Sold','3 More','4 Babies','A Donthave A Cat','Zz','Zzz','Www','Ww') then '' \n              when cp.pet_name ilike any ('%cats%','%kitten%','%litter%','%months%','%weeks%','%years%','%mth%','%wks%','%yrs%','%total%','%aaa%','%xxx%','%vvv%','%yet to%','%dogs%','%puppies%') then ''\n                                  else cp.pet_name end <> ''  \n   )\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"197425":{"id":197425,"sourceID":197420,"targetID":197422},"197426":{"id":197426,"sourceID":197427,"targetID":197420}},"failureConnectors":{},"unconditionalConnectors":{"197424":{"id":197424,"sourceID":197421,"targetID":197423},"197431":{"id":197431,"sourceID":197421,"targetID":197427}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"SFMC Pet Extract","description":"","type":"ORCHESTRATION","tag":"a09737b7-4e8e-40e5-a5e2-29e0a1decd4e"}}