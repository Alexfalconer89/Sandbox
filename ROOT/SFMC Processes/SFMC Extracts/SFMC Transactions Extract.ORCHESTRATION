{"job":{"components":{"197428":{"id":197428,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-224,"y":80,"width":32,"height":32,"inputConnectorIDs":[197438],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log Start"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC Transactions extract'\n,'START'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197429":{"id":197429,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[197437,197438],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197433":{"id":197433,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":16,"y":0,"width":32,"height":32,"inputConnectorIDs":[197439],"outputSuccessConnectorIDs":[197432],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3 Output"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\n    current_timestamp::timestamp_ntz,\n    '${Database}',\n    'BUILD',\n    'SFMC',\n    'SFMC transactions copy to s3',\n    'STARTED';\n\n\n\ncopy into 's3://${Bucket}/sfmc/from_bbw/transactions_${sfmc_file_date.now().format(\"dd_MM_yyyy\")}.csv'\nfrom (select *\nfrom ${Database}.db.sfmc_transactions_extract)\nstorage_integration = ${Database}_S3_SI\nfile_format = (type=CSV\ncompression = NONE\nRECORD_DELIMITER='\\r\\n',\nFIELD_DELIMITER=',',\nFIELD_OPTIONALLY_ENCLOSED_BY = '\"',\nDATE_FORMAT='YYYY-MM-DD',\nTIME_FORMAT='HH:NN:SS',\nTIMESTAMP_FORMAT='YYYY-MM-DD HH24:MI:SS',\nEMPTY_FIELD_AS_NULL = FALSE,\nNULL_IF=(''),\nENCODING='UTF8')\noverwrite = TRUE\nsingle = TRUE\nheader = TRUE\nMAX_FILE_SIZE=5368709120\n;\n\n/*\n    log rows selected for export --transactions\n*/\ninsert into ${Database}.db.SFMC_extracts_daily_counts_log\n(\n  select \n    'copy to s3 - table count',\n    current_date,\n    current_timestamp,\n    'transactions_'||TO_CHAR(current_date(),'DD_MM_YYYY')||'.csv',\n    count(*)\nfrom ${Database}.db.sfmc_transactions_extract\nwhere bbw_urn in (select bbw_urn from ${Database}.db.consumer_brand_daily_extract)\n);"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197434":{"id":197434,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":0,"width":32,"height":32,"inputConnectorIDs":[197432],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Log End"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into tbw.db.monitoring\n(monitoring_timestamp,client,process,description,sub_description,value)\nselect\nCURRENT_TIMESTAMP::timestamp_ntz\n,'${Database}'\n,'BUILD'\n,'SFMC'\n,'SFMC Transactions extract'\n,'END'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"197435":{"id":197435,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-93,"y":3,"width":32,"height":32,"inputConnectorIDs":[197437],"outputSuccessConnectorIDs":[197439],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Transactions Extract"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/******************************************************************************************\nProgram           : SFMC Transactions\nAuthor            : Mark Webb\nClient Name       : Nestle\nStandard Machine  : Snowflake\nAmendment History : v01 - CB 20220718 - Created\n******************************************************************************************/\n\ncreate or replace table ${Database}.db.sfmc_transactions_extract\nas\nselect \ndistinct\nbbw_urn,\nconcat(bbw_urn,'-',source_brand_id) as brand_bbw_urn,\nsource_brand_id as brand,\norder_number,\norder_created,\norder_status,\ncustomer_id,\nsite_name,\nhouse_number_or_name,\nline1,\nline2,\nline3,\nline4,\ntelephone,\ncurrency,\nordered_product_id,\norder_line_status,\nquantity_ordered,\ntransaction_order_shipping_cost,\ntransaction_charge_price_per_unit,\nshipment_number,\nreserved_product_id,\ndespatched_date,\ndespatched_qty,\nmispick_date,\nmispicked_qty,\ncancelled_date,\ncancelled_qty,\nexpected_dispatched_date,\nreleased_date,\ncontent_item_name_1,\ncontent_item_value_1,\na.source_date\nfrom ${Database}.live.npp_thg_trans a\njoin ${Database}.live.names b\non cast(a.customer_id as varchar) = cast(b.source_urn as varchar)\nwhere b.source = 'REG_THG'\nand bbw_urn in (select bbw_urn from ${Database}.db.consumer_brand_daily_extract);"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"197432":{"id":197432,"sourceID":197433,"targetID":197434},"197439":{"id":197439,"sourceID":197435,"targetID":197433}},"failureConnectors":{},"unconditionalConnectors":{"197437":{"id":197437,"sourceID":197429,"targetID":197435},"197438":{"id":197438,"sourceID":197429,"targetID":197428}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"SFMC Transactions Extract","description":"","type":"ORCHESTRATION","tag":"6c586248-2d78-475e-8dfe-87a1591bbbe8"}}